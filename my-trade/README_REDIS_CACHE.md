# Redisç¼“å­˜é›†æˆè¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ä¸ºäº†æå‡æ€§èƒ½ï¼Œé¿å…å‰ç«¯é¢‘ç¹è°ƒç”¨APIï¼Œæˆ‘ä»¬åœ¨åŸºé‡‘ä¼°å€¼æŸ¥è¯¢æ¥å£ä¸­é›†æˆäº†Redisç¼“å­˜æœºåˆ¶ï¼š

- âœ… **è‡ªåŠ¨ç¼“å­˜**: APIæŸ¥è¯¢ç»“æœè‡ªåŠ¨å­˜å…¥Redis
- âœ… **TTLè®¾ç½®**: ç¼“å­˜30ç§’åè‡ªåŠ¨è¿‡æœŸ
- âœ… **æ€§èƒ½æå‡**: ç¼“å­˜å‘½ä¸­å¯æå‡10-50å€æŸ¥è¯¢é€Ÿåº¦
- âœ… **æ™ºèƒ½é™çº§**: Redisä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§ä¸ºç›´æ¥APIè°ƒç”¨

## ğŸ“¦ æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `redis_cache.py` | Redisç¼“å­˜æ ¸å¿ƒæ¨¡å— |
| `redis_config.py` | Redisé…ç½®æ–‡ä»¶ |
| `test_redis_cache.py` | Redisç¼“å­˜æµ‹è¯•è„šæœ¬ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…Redis

#### macOS
```bash
brew install redis
brew services start redis
```

#### Ubuntu/Debian
```bash
sudo apt-get install redis-server
sudo systemctl start redis
```

#### Docker
```bash
docker run -d -p 6379:6379 --name redis redis:latest
```

### 2. å®‰è£…Pythonä¾èµ–

```bash
pip install redis==5.0.1
```

æˆ–ä½¿ç”¨requirementsæ–‡ä»¶ï¼š

```bash
pip install -r requirements_api.txt
```

### 3. é…ç½®Redisï¼ˆå¯é€‰ï¼‰

ç¼–è¾‘ `redis_config.py`:

```python
REDIS_CONFIG = {
    'host': 'localhost',      # Redisä¸»æœº
    'port': 6379,             # Redisç«¯å£
    'db': 0,                  # æ•°æ®åº“ç¼–å·
    'password': None,         # å¯†ç ï¼ˆå¦‚æœæœ‰ï¼‰
    'default_ttl': 30         # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
}
```

### 4. å¯åŠ¨æœåŠ¡

```bash
python fund_estimate_api.py
```

æœåŠ¡å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºRedisçŠ¶æ€ï¼š

```
================================================================================
åŸºé‡‘ä¼°å€¼APIæœåŠ¡å¯åŠ¨ä¸­...
================================================================================
APIç«¯ç‚¹:
  GET  /api/fund/estimate/<fund_code>  - æŸ¥è¯¢å•ä¸ªåŸºé‡‘ä¼°å€¼
  POST /api/fund/estimate/batch        - æ‰¹é‡æŸ¥è¯¢åŸºé‡‘ä¼°å€¼
  GET  /api/fund/search?keyword=xxx    - æœç´¢åŸºé‡‘
  GET  /api/fund/history/<fund_code>   - æŸ¥è¯¢å†å²ä¼°å€¼æ•°æ®
  GET  /api/health                     - å¥åº·æ£€æŸ¥
  POST /api/cache/clear                - æ¸…ç©ºRedisç¼“å­˜
================================================================================
æ•°æ®åº“çŠ¶æ€: âœ… å·²è¿æ¥
Redisç¼“å­˜: âœ… å·²å¯ç”¨ (TTL: 30ç§’)
================================================================================
```

## ğŸ” å·¥ä½œåŸç†

### ç¼“å­˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯è¯·æ±‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥Redisç¼“å­˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€ ç¼“å­˜å‘½ä¸­ â”€â”€â”
       â”‚               â”‚
       â”‚               â–¼
       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚        â”‚ è¿”å›ç¼“å­˜æ•°æ®â”‚ (å¿«é€Ÿ, <50ms)
       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â”€â”€ ç¼“å­˜æœªå‘½ä¸­
              â”‚
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ è°ƒç”¨AKShare â”‚
       â”‚    API      â”‚ (è¾ƒæ…¢, 1-3ç§’)
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ å­˜å…¥Redis   â”‚
       â”‚  (TTL=30s)  â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ è¿”å›æ•°æ®     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼“å­˜é”®æ ¼å¼

```
fund_estimate:<fund_code>

ä¾‹å¦‚:
- fund_estimate:000001  (åå¤æˆé•¿æ··åˆ)
- fund_estimate:161116  (æ˜“æ–¹è¾¾é»„é‡‘ä¸»é¢˜)
```

### ç¼“å­˜æ•°æ®ç»“æ„

```json
{
  "åŸºé‡‘ä»£ç ": "000001",
  "åŸºé‡‘åç§°": "åå¤æˆé•¿æ··åˆ",
  "å®æ—¶ä¼°ç®—å‡€å€¼": 1.1806,
  "å®æ—¶ä¼°ç®—å¢é•¿ç‡": "0.65%",
  "æœ€æ–°å…¬å¸ƒå‡€å€¼": 1.1670,
  "æœ€æ–°å…¬å¸ƒå¢é•¿ç‡": "-0.51%",
  "ä¸Šä¸€æ—¥å‡€å€¼": 1.1730,
  "ä¼°ç®—åå·®": "1.16%",
  "æŸ¥è¯¢æ—¶é—´": "2026-02-02 10:30:00",
  "_cached_at": "2026-02-02 10:30:00"
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æµ‹è¯•æ•°æ®

| æŸ¥è¯¢æ–¹å¼ | å“åº”æ—¶é—´ | æå‡å€æ•° |
|---------|---------|---------|
| é¦–æ¬¡æŸ¥è¯¢ï¼ˆAPIï¼‰ | 1.5-3.0ç§’ | åŸºå‡† |
| ç¼“å­˜æŸ¥è¯¢ï¼ˆRedisï¼‰ | 0.05-0.1ç§’ | 15-60å€ |

### å®é™…æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
python test_redis_cache.py
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
ã€æµ‹è¯•2ã€‘ç¬¬ä¸€æ¬¡æŸ¥è¯¢åŸºé‡‘ 000001ï¼ˆåº”è¯¥è°ƒç”¨APIï¼‰
ğŸ“Š æ­£åœ¨æŸ¥è¯¢åŸºé‡‘ 000001 çš„å®æ—¶ä¼°å€¼...
âœ… æŸ¥è¯¢æˆåŠŸ: åå¤æˆé•¿æ··åˆ
   å‡€å€¼: 1.1806
   è€—æ—¶: 2.15ç§’

ã€æµ‹è¯•3ã€‘ç¬¬äºŒæ¬¡æŸ¥è¯¢åŸºé‡‘ 000001ï¼ˆåº”è¯¥ä»Redisç¼“å­˜è¯»å–ï¼‰
âœ… ä»Redisç¼“å­˜è·å–åŸºé‡‘ 000001 æ•°æ®
âœ… æŸ¥è¯¢æˆåŠŸ: åå¤æˆé•¿æ··åˆ
   å‡€å€¼: 1.1806
   è€—æ—¶: 0.08ç§’

ğŸš€ æ€§èƒ½æå‡: 26.9å€ (ä» 2.15ç§’ é™åˆ° 0.08ç§’)
```

## ğŸ”§ APIæ¥å£

### å¥åº·æ£€æŸ¥ï¼ˆåŒ…å«RedisçŠ¶æ€ï¼‰

```
GET /api/health
```

å“åº”ï¼š

```json
{
  "status": "ok",
  "timestamp": "2026-02-02 10:30:00",
  "redis_enabled": true,
  "redis_stats": {
    "enabled": true,
    "connected_clients": 1,
    "used_memory_human": "1.2M",
    "total_keys": 5,
    "uptime_in_seconds": 3600
  },
  "database_enabled": true
}
```

### æ¸…ç©ºç¼“å­˜

```
POST /api/cache/clear
Content-Type: application/json

{
  "prefix": "fund_estimate"
}
```

å“åº”ï¼š

```json
{
  "success": true,
  "message": "æ¸…ç©ºç¼“å­˜æˆåŠŸ",
  "count": 10
}
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: é«˜é¢‘æŸ¥è¯¢

å‰ç«¯æ¯10ç§’åˆ·æ–°ä¸€æ¬¡åŸºé‡‘æ•°æ®ï¼š

```typescript
// å‰ç«¯ä»£ç 
setInterval(async () => {
  const data = await fetchFundEstimate('000001')
  // 30ç§’å†…çš„æŸ¥è¯¢éƒ½ä¼šå‘½ä¸­ç¼“å­˜ï¼Œä¸ä¼šç»™APIæœåŠ¡å™¨é€ æˆå‹åŠ›
}, 10000)
```

### åœºæ™¯2: æ‰¹é‡æŸ¥è¯¢

```bash
# æ‰¹é‡æŸ¥è¯¢å¤šä¸ªåŸºé‡‘
curl -X POST http://localhost:8083/api/fund/estimate/batch \
  -H "Content-Type: application/json" \
  -d '{"codes": ["000001", "161116", "110022"]}'

# å¦‚æœè¿™äº›åŸºé‡‘åœ¨30ç§’å†…è¢«æŸ¥è¯¢è¿‡ï¼Œä¼šç›´æ¥ä»ç¼“å­˜è¿”å›
```

### åœºæ™¯3: ä¸»åŠ¨æ¸…ç©ºç¼“å­˜

å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼š

```bash
# æ¸…ç©ºæ‰€æœ‰åŸºé‡‘ä¼°å€¼ç¼“å­˜
curl -X POST http://localhost:8083/api/cache/clear \
  -H "Content-Type: application/json" \
  -d '{"prefix": "fund_estimate"}'

# ä¸‹æ¬¡æŸ¥è¯¢ä¼šé‡æ–°è°ƒç”¨APIè·å–æœ€æ–°æ•°æ®
```

## âš™ï¸ é…ç½®è¯´æ˜

### TTLè®¾ç½®

ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰é»˜è®¤30ç§’ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼š

```python
# åœ¨fund_estimate_api.pyä¸­
fund_api = FundAPI(use_redis=True, redis_ttl=30)  # 30ç§’

# æˆ–è€…æ›´é•¿
fund_api = FundAPI(use_redis=True, redis_ttl=60)  # 60ç§’
```

**å»ºè®®å€¼:**
- å®æ—¶è¡Œæƒ…: 10-30ç§’
- ä¸€èˆ¬åœºæ™¯: 30-60ç§’
- ä½é¢‘æ›´æ–°: 60-300ç§’

### ç¦ç”¨Redis

å¦‚æœä¸éœ€è¦Redisç¼“å­˜ï¼š

```python
# æ–¹å¼1: åˆå§‹åŒ–æ—¶ç¦ç”¨
fund_api = FundAPI(use_redis=False)

# æ–¹å¼2: Redisä¸å¯ç”¨æ—¶è‡ªåŠ¨ç¦ç”¨
# æœåŠ¡ä¼šæ£€æµ‹Redisè¿æ¥çŠ¶æ€ï¼Œè¿æ¥å¤±è´¥è‡ªåŠ¨é™çº§
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: Redisè¿æ¥å¤±è´¥

**ç°è±¡:**
```
âš ï¸  Redisè¿æ¥å¤±è´¥: Error 111 connecting to localhost:6379. Connection refused
âš ï¸  Redisç¼“å­˜æœªå¯ç”¨ï¼Œå°†ç›´æ¥è°ƒç”¨API
```

**è§£å†³:**
```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping
# åº”è¯¥è¿”å›: PONG

# å¦‚æœæ²¡æœ‰è¿è¡Œï¼Œå¯åŠ¨Redis
# macOS:
brew services start redis

# Linux:
sudo systemctl start redis

# Docker:
docker start redis
```

### é—®é¢˜2: ç¼“å­˜æœªç”Ÿæ•ˆ

**ç°è±¡:**
- æŸ¥è¯¢é€Ÿåº¦æ²¡æœ‰æå‡
- æ—¥å¿—æ˜¾ç¤º "æ­£åœ¨æŸ¥è¯¢åŸºé‡‘..." è€Œä¸æ˜¯ "ä»Redisç¼“å­˜è·å–"

**æ’æŸ¥:**
```bash
# 1. æ£€æŸ¥Redisä¸­çš„é”®
redis-cli keys "fund_estimate:*"

# 2. æŸ¥çœ‹æŸä¸ªé”®çš„å€¼
redis-cli get "fund_estimate:000001"

# 3. æŸ¥çœ‹TTL
redis-cli ttl "fund_estimate:000001"
```

### é—®é¢˜3: å†…å­˜å ç”¨

**ç°è±¡:**
- Rediså†…å­˜ä½¿ç”¨è¿‡é«˜

**è§£å†³:**
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
redis-cli info memory

# æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
redis-cli flushdb

# æˆ–é€šè¿‡APIæ¸…ç©º
curl -X POST http://localhost:8083/api/cache/clear
```

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

1. **ç¼“å­˜å‘½ä¸­ç‡**
   - å…¬å¼: (ç¼“å­˜å‘½ä¸­æ¬¡æ•° / æ€»æŸ¥è¯¢æ¬¡æ•°) Ã— 100%
   - ç›®æ ‡: >80%

2. **å¹³å‡å“åº”æ—¶é—´**
   - ç¼“å­˜å‘½ä¸­: <100ms
   - ç¼“å­˜æœªå‘½ä¸­: 1-3ç§’

3. **Rediså†…å­˜ä½¿ç”¨**
   - å•ä¸ªåŸºé‡‘æ•°æ®: ~1KB
   - 1000ä¸ªåŸºé‡‘: ~1MB

### ç›‘æ§æ–¹æ³•

```bash
# æŸ¥çœ‹Redisç»Ÿè®¡
redis-cli info stats

# æŸ¥çœ‹å‘½ä»¤ç»Ÿè®¡
redis-cli --stat

# å®æ—¶ç›‘æ§
redis-cli monitor
```

## ğŸ“ æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®TTL**
   - æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è®¾ç½®
   - äº¤æ˜“æ—¶é—´å†…å¯ä»¥è®¾ç½®æ›´çŸ­çš„TTL

2. **å®šæœŸæ¸…ç†**
   - æ”¶ç›˜åæ¸…ç©ºç¼“å­˜
   - é¿å…è¿‡æœŸæ•°æ®å½±å“

3. **ç›‘æ§å‘Šè­¦**
   - ç›‘æ§Redisè¿æ¥çŠ¶æ€
   - ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

4. **å®¹ç¾é™çº§**
   - Redisæ•…éšœæ—¶è‡ªåŠ¨é™çº§
   - ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

## ğŸ”— ç›¸å…³èµ„æº

- Rediså®˜æ–¹æ–‡æ¡£: https://redis.io/docs/
- redis-pyæ–‡æ¡£: https://redis-py.readthedocs.io/
- Redisæœ€ä½³å®è·µ: https://redis.io/docs/manual/patterns/

---

**æ›´æ–°æ—¶é—´**: 2026-02-02  
**ç‰ˆæœ¬**: v1.1 (é›†æˆRedisç¼“å­˜)
